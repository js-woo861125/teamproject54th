<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ks54team01.admin.productInfo.mapper.AdminProductInfoMapper">

	<!-- resultMap : 조회 결과를 자바 클래스(domain,dto)와 명시적으로 매핑설정 -->
	<resultMap type="ProductInfoCategory" id="categoryResultMap">
		<!-- id : 테이블 pk 컬럼 -->
		<id 	column="product_category_no" property="categoryNo"/>
		<!-- result : 테이블 일반 컬럼 -->
		<result column="manager_id"  		property="managerId"/>
		<result column="large_category_no" 	property="lgCategoryNo"/>	
		<result column="large_category" 	property="lgCategory"/>	
		<result column="middle_category_no" property="mdCategoryNo"/>	
		<result column="middle_category" 	property="mdCategory"/>	
		<result column="small_category" 	property="smCategory"/>
		<result column="register_date"  	property="categoryRegDate"/>
		<result column="revision_date"  	property="categoryRevDate"/>	
		<result column="use_status" 		property="useStatus"/>	
	</resultMap>
	
	<resultMap type="ProductInfoBrand" id="brandResultMap">
		<id 	column="brand_no" 	 	property="brandNo"/>
		<result column="manager_id"  	property="managerId"/>
		<result column="brand_nm" 	 	property="brandName"/>	
		<result column="register_date"  property="brandRegDate"/>
		<result column="revision_date"  property="brandRevDate"/>			
		<result column="use_status"  	property="useStatus"/>
	</resultMap>
	
	<resultMap type="ProductInfoItem" id="itemResultMap">
		<id 	column="item_no" 	 	property="itemNo"/>
		<result column="manager_id"  	property="managerId"/>
		<result column="item_nm" 	 	property="itemName"/>	
		<result column="register_date"  property="itemRegDate"/>
		<result column="revision_date"  property="itemRevDate"/>	
		<result column="use_status"  	property="useStatus"/>	
		
		<association property="categoryInfo" javaType="ProductInfoCategory">
			<id 	column="product_category_no"	property="categoryNo"/>
			<result column="product_category_no"	property="categoryNo"/>
		</association>
	</resultMap>
	
	<resultMap type="ProductInfoModel" id="modelResultMap">
		<id 	column="model_no" 	 	property="modelNo"/>
		<result column="manager_id"  	property="managerId"/>
		<result column="model_nm" 	 	property="modelName"/>	
		<result column="register_date"  property="modelRegDate"/>
		<result column="revision_date"  property="modelRevDate"/>	
		<result column="use_status"  	property="useStatus"/>	
		
		<association property="categoryInfo" javaType="ProductInfoCategory">
			<id 	column="product_category_no"	property="categoryNo"/>
			<result column="product_category_no"	property="categoryNo"/>
		</association>
		<association property="brandInfo" javaType="ProductInfoBrand">
			<id 	column="brand_no"	property="brandNo"/>
			<result column="brand_no"	property="brandNo"/>
		</association>
		<association property="itemInfo" javaType="ProductInfoItem">
			<id 	column="item_no"	property="itemNo"/>
			<result column="item_no"	property="itemNo"/>
		</association>
	</resultMap>
	
	<resultMap type="ProductInfoBenefit" id="benefitResultMap">
		<id 	column="benefit_no" 	property="benefitNo"/>
		<result column="manager_id"  	property="managerId"/>
		<result column="benefit_nm" 	property="benefitName"/>	
		<result column="register_date"  property="benefitRegDate"/>
		<result column="revision_date"  property="benefitRevDate"/>	
		<result column="use_status"  	property="useStatus"/>	
	</resultMap>
	
	<resultMap type="ProductInfoCategorySpec" id="categorySpecResultMap">
		<id 	column="spec_no" 	 	property="specNo"/>
		<result column="manager_id"  	property="managerId"/>
		<result column="spec_nm" 	 	property="specName"/>	
		<result column="register_date"  property="specRegDate"/>
		<result column="revision_date"  property="specRevDate"/>	
		<result column="use_status"  	property="useStatus"/>		
		
		<association property="categoryInfo" javaType="ProductInfoCategory">
			<id 	column="product_category_no"	property="categoryNo"/>
			<result column="small_category"			property="smCategory"/>
		</association>
	</resultMap>

	<delete id="removeBrandInfoByNo" parameterType="String">
		/* 상품정보 브랜드 삭제 */
		DELETE 
		FROM 
			brand
		WHERE 
			brand_no = #{brandNo};
	</delete>

	<select id="isBrandNameCheck" parameterType="String" resultType="boolean">
		/* 브랜드명 중복체크 */
		SELECT
			count(*)
		FROM
			brand
		WHERE
			brand_nm = #{brandName};
	</select>

	<update id="modifyCategorySpec" parameterType="ProductInfoCategorySpec">
		/* 상품정보 카테고리별/상세스펙 수정 */
		UPDATE products_spec
		<trim prefix="SET" suffixOverrides=",">
		<if test="specName != null and specName != ''">
		    spec_nm=#{specName}
		</if>
		</trim>
		WHERE
			spec_no = #{specNo};
	</update>	
		
	<update id="modifyBenefit" parameterType="ProductInfoBenefit">
		/* 상품정보 전체혜택 수정 */
		UPDATE benefit
		<trim prefix="SET" suffixOverrides=",">
		<if test="benefitName != null and benefitName != ''">
		    benefit_nm=#{benefitName}
		</if>
		</trim>
		WHERE
			benefit_no = #{benefitNo};
	</update>
	
	<update id="modifyModel" parameterType="ProductInfoModel">
		/* 상품정보 모델 수정 */
		UPDATE model
		<trim prefix="SET" suffixOverrides=",">
		<if test="modelNo != null and modelNo != ''">
		    model_nm=#{modelName}
		</if>
		</trim>
		WHERE
			model_no = #{modelNo};
	</update>
	
	<update id="modifyItem" parameterType="ProductInfoItem">
		/* 상품정보 품목 수정 */
		UPDATE item
		SET
		   product_category_no = #{categoryNo},
		   item_nm = #{itemName},
		   revision_date = NOW()
		WHERE
			item_no = #{itemNo};
	</update>
	
	<update id="modifyBrand" parameterType="ProductInfoBrand">
		/* 상품정보 브랜드 수정 */
		UPDATE brand
		SET
			brand_nm = #{brandName},
			revision_date = NOW()
		WHERE
			brand_no = #{brandNo};
	</update>
	
	<update id="modifyCategory" parameterType="ProductInfoCategory">
		/* 상품정보 카테고리 수정 */
		UPDATE products_category 
		SET 
			large_category = #{lgCategory},
			middle_category = #{mdCategory},
			small_category = #{smCategory},
			revision_date = NOW()
		WHERE 
		  product_category_no = #{categoryNo};
	</update>
	
	<select id="getCategorySpecInfoByNo" parameterType="String" resultMap="categorySpecResultMap">
		/* 상품정보 카테고리별/상세스펙 조회 */
		SELECT 
			spec_no, 
			manager_id, 
			product_category_no, 
			spec_nm, 
			register_date, 
			revision_date, 
			use_status
		FROM 
			products_spec
		WHERE
			spec_no = #{specNo};
	</select>
	
	<select id="getBenefitInfoByNo" parameterType="String" resultMap="benefitResultMap">
		/* 상품정보 전체혜택 조회 */
		SELECT 
			benefit_no, 
			manager_id, 
			benefit_nm, 
			register_date, 
			revision_date, 
			use_status
		FROM 
			benefit
		WHERE
			benefit_no = #{benefitNo};	
	</select>
	
	<select id="getModelInfoByNo" parameterType="String" resultMap="modelResultMap"> 
		/* 상품정보 모델 조회 */
		SELECT 
			model_no, 
			manager_id, 
			brand_no, 
			item_no, 
			product_category_no, 
			model_nm, 
			register_date, 
			revision_date, 
			use_status
		FROM 
			model
		WHERE
			model_no = #{modelNo};	
	</select>
	
	<select id="getItemInfoByNo" parameterType="String" resultMap="itemResultMap"> 
		/* 상품정보 품목 조회 */
		SELECT 
			item_no, 
			manager_id, 
			product_category_no, 
			item_nm, 
			register_date, 
			revision_date, 
			use_status
		FROM 
			item
		WHERE
			item_no = #{itemNo};	
	</select>
	
	<select id="getBrandInfoByNo" parameterType="String" resultMap="brandResultMap"> 
		/* 상품정보 브랜드 조회 */
		SELECT 
			brand_no, 
			manager_id, 
			brand_nm, 
			register_date, 
			revision_date, 
			use_status
		FROM 
			brand
		WHERE
			brand_no = #{brandNo};
	</select>
	
	<select id="getCategoryInfoByNo" parameterType="String" resultMap="categoryResultMap">
		/* 상품정보 카테고리 조회 */
		SELECT 
			product_category_no, 
			manager_id, 
			large_category_no, 
			large_category, 
			middle_category_no, 
			middle_category, 
			small_category, 
			register_date, 
			revision_date, 
			use_status
		FROM 
			products_category
		WHERE
			product_category_no = #{categoryNo};
	</select>
	
	<insert id="addCategorySpec" parameterType="ProductInfoCategorySpec">
		<selectKey keyProperty="specNo" resultType="string" order="BEFORE">
		/* 스펙코드 자동증가 */
		SELECT 
			case
			when count(*) = 0 then 'spec_1'
			else
				concat('spec_',max(cast(SUBSTRING_INDEX(spec_no, '_', -1) as unsigned))+1)
			end as specNo	
		FROM
			products_spec;
		</selectKey>
		/* 상품정보 카테고리별/상세스펙 등록 */
		INSERT INTO products_spec
		(spec_no, manager_id, product_category_no, spec_nm, register_date, revision_date, use_status)
		VALUES
		(#{specNo}, #{managerId}, #{categoryNo}, #{specName}, NOW(), NOW(), '사용중');
	</insert>
	
	<insert id="addBenefit" parameterType="ProductInfoBenefit">
		<selectKey keyProperty="benefitNo" resultType="string" order="BEFORE">
		/* 혜택코드 자동증가 */
		SELECT 
			case
			when count(*) = 0 then 'benefit_1'
			else
				concat('benefit_',max(cast(SUBSTRING_INDEX(benefit_no, '_', -1) as unsigned))+1)
			end as benefitNo	
		FROM
			benefit;
		</selectKey>
		/* 상품정보 전체혜택 등록 */
		INSERT INTO benefit
		(benefit_no, manager_id, benefit_nm, register_date, revision_date, use_status)
		VALUES
		(#{benefitNo}, #{managerId}, #{benefitName}, NOW(), NOW(), '사용중');
	</insert>
	
	<insert id="addModel" parameterType="ProductInfoModel">
		<selectKey keyProperty="modelNo" resultType="string" order="BEFORE">
		/* 모델코드 자동증가 */
		SELECT 
			case
			when count(*) = 0 then 'model_1'
			else
				concat('model_',max(cast(SUBSTRING_INDEX(model_no, '_', -1) as unsigned))+1)
			end as modelNo	
		FROM
			model;
		</selectKey>
		/* 상품정보 모델 등록 */
		INSERT INTO model
		(model_no, manager_id, brand_no, item_no, product_category_no, model_nm, register_date, revision_date, use_status)
		VALUES
		(#{modelNo}, #{managerId}, #{brandNo}, #{itemNo}, #{categoryNo}, #{modelName}, NOW(), NOW(), '사용중');
	</insert>
	
	<insert id="addItem" parameterType="ProductInfoItem">
		<selectKey keyProperty="itemNo" resultType="string" order="BEFORE">
		/* 품목코드 자동증가 */
		SELECT 
			case
			when count(*) = 0 then 'item_1'
			else
				concat('item_',max(cast(SUBSTRING_INDEX(item_no, '_', -1) as unsigned))+1)
			end as itemNo	
		FROM
			item;
		</selectKey>
		/* 상품정보 품목 등록 */
		INSERT INTO item
		(item_no, manager_id, product_category_no, item_nm, register_date, revision_date, use_status)
		VALUES
		(#{itemNo}, #{managerId}, #{categoryNo}, #{itemName}, NOW(), NOW(), '사용중');
	</insert>
	
	<insert id="addBrand" parameterType="ProductInfoBrand">
		<selectKey keyProperty="brandNo" resultType="string" order="BEFORE">
		/* 브랜드코드 자동증가 */
		SELECT 
			case
			when count(*) = 0 then 'brand_1'
			else
				CONCAT('brand_',max(cast(SUBSTRING_INDEX(brand_no, '_', -1) as unsigned))+1)
			end as brandNo	
		FROM
			brand;
		</selectKey>
		/* 상품정보 브랜드 등록 */
		INSERT INTO brand
		(brand_no, manager_id, brand_nm, register_date, revision_date, use_status)
		VALUES
		(#{brandNo}, #{managerId}, #{brandName}, NOW(), NOW(), '사용중');
	</insert>
	
	<insert id="addCategory" parameterType="ProductInfoCategory">
	    <selectKey keyProperty="categoryNo" resultType="string" order="BEFORE">
	    /* 카테고리코드 자동증가 */
        SELECT
            CASE
                WHEN COUNT(*) = 0 THEN CONCAT(#{lgCategoryNo}, '_', #{mdCategoryNo}, '_1') -- 최초에는 1번
                ELSE CONCAT(#{lgCategoryNo}, '_', #{mdCategoryNo}, '_', 
                            MAX(CAST(SUBSTRING_INDEX(product_category_no, '_', -1) AS UNSIGNED)) + 1) -- 기존 값들 중에서 최대값 + 1
            END AS product_category_no
        FROM
            products_category
        WHERE
            large_category_no = #{lgCategoryNo} 
            AND middle_category_no = #{mdCategoryNo} 
	    </selectKey>
	
	    /* 상품정보 카테고리 등록 */
	    INSERT INTO products_category
		(product_category_no, manager_id, large_category_no, large_category, middle_category_no, middle_category, small_category, register_date, revision_date, use_status)
		VALUES
		(#{categoryNo}, #{managerId}, #{lgCategoryNo}, #{lgCategory}, #{mdCategoryNo}, #{mdCategory}, #{smCategory}, NOW(), NOW(), '사용중');
	</insert>

	<select id="getCategorySpecList" resultMap="categorySpecResultMap">
		/* 상품정보 카테고리별/상세스펙 목록 조회 */
		SELECT
			ps.spec_no,
			ps.manager_id,
			pc.small_category,
			ps.spec_nm,
			ps.register_date,
			ps.revision_date,
			ps.use_status
		FROM
			products_spec ps inner join products_category pc 
			using(product_category_no);
	</select>
	
	<select id="getBenefitList" resultMap="benefitResultMap">
		/* 상품정보 전체혜택 목록 조회 */
		SELECT 
			benefit_no,
			manager_id,
			benefit_nm,
			register_date,
			revision_date,
			use_status
		FROM 
			benefit;	
	</select>
	
	<select id="getModelList" resultMap="modelResultMap">
		/* 상품정보 모델 목록 조회 */
		SELECT 
			m.model_no,
			m.manager_id,
			b.brand_no,
			i.item_no,
			pc.product_category_no,
			m.model_nm,
			m.register_date,
			m.revision_date,
			m.use_status
		FROM 
			model m inner join products_category pc
			using(product_category_no)
			inner join item i
			using(item_no)
			left join brand b
			using(brand_no);
	</select>
	
	<select id="getItemList" resultMap="itemResultMap">
		/* 상품정보 품목 목록 조회 */
		SELECT 
			i.item_no,
			i.manager_id,
			pc.product_category_no,
			i.item_nm,
			i.register_date,
			i.revision_date,
			i.use_status
		FROM 
			item i inner join products_category pc
			using(product_category_no);
	</select>
	
	<select id="getBrandList" resultMap="brandResultMap">
		/* 상품정보 브랜드 목록 조회 */
		SELECT 
			brand_no,
			manager_id,
			brand_nm, 
			register_date,
			revision_date,
			use_status
		FROM 
			brand
		ORDER BY CAST(SUBSTRING_INDEX(brand_no, '_', -1) AS UNSIGNED);
	</select>
	
	<select id="getCategoryList" resultMap="categoryResultMap">
		/* 상품정보 카테고리 목록 조회 */
		SELECT 
			product_category_no,
			manager_id,
			large_category_no, 
			large_category, 
			middle_category_no, 
			middle_category, 
			small_category,			
			register_date,
			revision_date,
			use_status
		FROM 
			products_category;	 
	</select>
	<insert id="insertProduct" parameterType="ks54team01.admin.product.domain.AdminAddProduct">
	    INSERT INTO products (
	        products_no,
	        manager_id,
	        model_no,
	        item_no,
	        product_category_no,
	        products_nm,
	        products_status,
	        products_image,
	        register_date,
	        revision_date
	    )
	    VALUES (
	        #{productNo},
	        #{managerId},
	        #{modelNo},
	        #{itemNo},
	        #{categoryNo},
	        #{productName},
	        #{productStatus},
	        #{productImage},
	        #{registerDate},
	        #{revisionDate}
	    )
	</insert>
</mapper>
